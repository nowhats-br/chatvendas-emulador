var h=Object.defineProperty;var f=(r,e,a)=>e in r?h(r,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):r[e]=a;var m=(r,e,a)=>f(r,typeof e!="symbol"?e+"":e,a);class v{constructor(){m(this,"config",null);m(this,"templates",[]);m(this,"sequences",[]);m(this,"personalization",{useFirstName:!0,greetingByTime:!0,emojiLevel:"medium",toneOfVoice:"friendly",maxMessageLength:300,includeCompanyName:!1,companyName:""});try{this.loadConfig(),this.setupDefaultTemplates(),this.setupDefaultSequences()}catch(e){console.warn("Erro ao inicializar AIConfigService:",e),this.config=null}}loadConfig(){try{const e=localStorage.getItem("chatvendas_ai_config");e&&(this.config=JSON.parse(e));const a=localStorage.getItem("chatvendas_ai_templates");a&&(this.templates=JSON.parse(a));const t=localStorage.getItem("chatvendas_ai_sequences");t&&(this.sequences=JSON.parse(t));const o=localStorage.getItem("chatvendas_ai_personalization");o&&(this.personalization={...this.personalization,...JSON.parse(o)})}catch(e){console.warn("Erro ao carregar configuraÃ§Ã£o de IA:",e),this.config=null}}save(){try{this.config&&localStorage.setItem("chatvendas_ai_config",JSON.stringify(this.config)),localStorage.setItem("chatvendas_ai_templates",JSON.stringify(this.templates)),localStorage.setItem("chatvendas_ai_sequences",JSON.stringify(this.sequences)),localStorage.setItem("chatvendas_ai_personalization",JSON.stringify(this.personalization)),window.dispatchEvent(new Event("ai-config-update"))}catch(e){console.error("Erro ao salvar configuraÃ§Ã£o de IA:",e)}}getProviders(){return[{id:"openai",name:"OpenAI (ChatGPT)",description:"GPT-3.5 Turbo, GPT-4, GPT-4 Turbo",apiKeyLabel:"OpenAI API Key",modelOptions:["gpt-3.5-turbo","gpt-4","gpt-4-turbo-preview"],defaultModel:"gpt-3.5-turbo"},{id:"gemini",name:"Google Gemini",description:"Gemini Pro, Gemini Pro Vision",apiKeyLabel:"Google AI API Key",modelOptions:["gemini-pro","gemini-pro-vision"],defaultModel:"gemini-pro"}]}getConfig(){return this.config}isConfigured(){try{return this.config!==null&&this.config.enabled&&this.config.apiKey.length>0}catch(e){return console.warn("Erro ao verificar configuraÃ§Ã£o de IA:",e),!1}}updateConfig(e){this.config=e,this.save()}clearConfig(){this.config=null,localStorage.removeItem("chatvendas_ai_config"),window.dispatchEvent(new Event("ai-config-update"))}setupDefaultTemplates(){this.templates.length===0&&(this.templates=[{id:"post_sale_confirmation",name:"ConfirmaÃ§Ã£o PÃ³s-Venda",type:"text",context:"sale_completed",prompt:`Gere uma mensagem de confirmaÃ§Ã£o de venda personalizada e amigÃ¡vel.
Contexto: Cliente {{nome}} acabou de comprar {{produtos}} por {{valor}}.
Inclua: agradecimento, confirmaÃ§Ã£o do pedido, prÃ³ximos passos.
Tom: {{toneOfVoice}}, mÃ¡ximo {{maxLength}} caracteres.`,variables:["nome","produtos","valor","protocolo"],active:!0},{id:"post_sale_satisfaction",name:"Pesquisa de SatisfaÃ§Ã£o",type:"buttons",context:"sale_completed_7days",prompt:`Gere uma mensagem pedindo feedback sobre a compra.
Cliente: {{nome}}, comprou hÃ¡ 7 dias: {{produtos}}.
Inclua: pergunta sobre satisfaÃ§Ã£o, botÃµes de avaliaÃ§Ã£o.
Tom: {{toneOfVoice}}, use emojis {{emojiLevel}}.`,variables:["nome","produtos","dataCompra"],active:!0},{id:"cart_abandoned_recovery",name:"RecuperaÃ§Ã£o Carrinho Abandonado",type:"buttons",context:"cart_abandoned",prompt:`Gere mensagem para recuperar carrinho abandonado.
Cliente: {{nome}}, abandonou carrinho com {{produtos}} ({{valor}}).
Inclua: lembrete gentil, urgÃªncia sutil, botÃ£o para finalizar.
Tom: {{toneOfVoice}}, mÃ¡ximo {{maxLength}} caracteres.`,variables:["nome","produtos","valor","desconto"],active:!0},{id:"vip_reactivation",name:"ReativaÃ§Ã£o Cliente VIP",type:"list",context:"vip_inactive",prompt:`Gere mensagem para reativar cliente VIP inativo.
Cliente: {{nome}}, LTV: {{ltv}}, Ãºltima compra hÃ¡ {{diasUltimaCompra}} dias.
Inclua: reconhecimento VIP, ofertas exclusivas, lista de produtos.
Tom: {{toneOfVoice}}, use emojis {{emojiLevel}}.`,variables:["nome","ltv","diasUltimaCompra","produtosPreferidos"],active:!0},{id:"lead_nurturing",name:"NutriÃ§Ã£o de Lead",type:"text",context:"lead_cold",prompt:`Gere mensagem para aquecer lead frio.
Lead: {{nome}}, sem compras, tags: {{tags}}.
Inclua: valor educativo, dica Ãºtil, call-to-action suave.
Tom: {{toneOfVoice}}, mÃ¡ximo {{maxLength}} caracteres.`,variables:["nome","tags","interesse"],active:!0},{id:"birthday_celebration",name:"ParabÃ©ns AniversÃ¡rio",type:"buttons",context:"birthday",prompt:`Gere mensagem de aniversÃ¡rio personalizada.
Cliente: {{nome}}, aniversÃ¡rio hoje, histÃ³rico: {{totalCompras}} compras.
Inclua: parabÃ©ns calorosos, oferta especial, botÃ£o para usar desconto.
Tom: {{toneOfVoice}}, use muitos emojis festivos.`,variables:["nome","totalCompras","descontoAniversario"],active:!0}],this.save())}setupDefaultSequences(){this.sequences.length===0&&(this.sequences=[{id:"post_sale_complete",name:"SequÃªncia PÃ³s-Venda Completa",trigger:"sale_completed",templates:[this.templates.find(e=>e.id==="post_sale_confirmation"),this.templates.find(e=>e.id==="post_sale_satisfaction")],delays:[0,7],active:!0},{id:"cart_recovery_sequence",name:"RecuperaÃ§Ã£o Carrinho Abandonado",trigger:"cart_abandoned",templates:[this.templates.find(e=>e.id==="cart_abandoned_recovery")],delays:[1],active:!0},{id:"vip_reactivation_sequence",name:"ReativaÃ§Ã£o Cliente VIP",trigger:"vip_inactive",templates:[this.templates.find(e=>e.id==="vip_reactivation")],delays:[0],active:!0},{id:"lead_nurturing_sequence",name:"NutriÃ§Ã£o de Leads Frios",trigger:"lead_cold",templates:[this.templates.find(e=>e.id==="lead_nurturing")],delays:[3],active:!0},{id:"birthday_sequence",name:"SequÃªncia AniversÃ¡rio",trigger:"birthday",templates:[this.templates.find(e=>e.id==="birthday_celebration")],delays:[0],active:!0}],this.save())}getTemplates(){return[...this.templates]}getSequences(){return[...this.sequences]}getPersonalization(){return{...this.personalization}}updatePersonalization(e){this.personalization={...this.personalization,...e},this.save()}updateTemplate(e,a){const t=this.templates.findIndex(o=>o.id===e);t!==-1&&(this.templates[t]={...this.templates[t],...a},this.save())}updateSequence(e,a){const t=this.sequences.findIndex(o=>o.id===e);t!==-1&&(this.sequences[t]={...this.sequences[t],...a},this.save())}async generateText(e,a){if(!this.isConfigured())throw new Error("IA nÃ£o configurada. Configure uma API key primeiro.");const t=this.config;try{if(t.provider==="openai")return await this.callOpenAI(e,a);if(t.provider==="gemini")return await this.callGemini(e,a);throw new Error("Provedor de IA nÃ£o suportado")}catch(o){throw console.error("Erro ao gerar texto com IA:",o),o}}async generateSmartMessage(e,a,t){if(!this.isConfigured())return this.getFallbackMessage(e,a);const o=this.templates.find(i=>i.id===e);if(!o||!o.active)return this.getFallbackMessage(e,a);try{const i=this.processPromptVariables(t||o.prompt,a),s=await this.generateText(i,a);return this.processAIResponse(s,o.type,a)}catch(i){return console.error("Erro ao gerar mensagem inteligente:",i),this.getFallbackMessage(e,a)}}processPromptVariables(e,a){const t=this.getFirstName(a.contactName),o=this.personalization.greetingByTime?this.getTimeBasedGreeting():"",i=this.personalization.includeCompanyName?this.personalization.companyName:"";let s=e.replace(/\{\{nome\}\}/g,t).replace(/\{\{nomeCompleto\}\}/g,a.contactName).replace(/\{\{telefone\}\}/g,a.contactPhone).replace(/\{\{saudacao\}\}/g,o).replace(/\{\{empresa\}\}/g,i||"").replace(/\{\{toneOfVoice\}\}/g,this.personalization.toneOfVoice).replace(/\{\{emojiLevel\}\}/g,this.personalization.emojiLevel).replace(/\{\{maxLength\}\}/g,this.personalization.maxMessageLength.toString());return a.ltv&&(s=s.replace(/\{\{ltv\}\}/g,`R$ ${a.ltv.toLocaleString("pt-BR")}`)),a.lastPurchaseValue&&(s=s.replace(/\{\{valor\}\}/g,`R$ ${a.lastPurchaseValue.toLocaleString("pt-BR")}`)),a.lastPurchaseProducts&&(s=s.replace(/\{\{produtos\}\}/g,a.lastPurchaseProducts.join(", "))),a.daysSinceLastPurchase&&(s=s.replace(/\{\{diasUltimaCompra\}\}/g,a.daysSinceLastPurchase.toString())),a.contactTags&&(s=s.replace(/\{\{tags\}\}/g,a.contactTags.join(", "))),a.totalPurchases&&(s=s.replace(/\{\{totalCompras\}\}/g,a.totalPurchases.toString())),s+=`

InstruÃ§Ãµes de personalizaÃ§Ã£o:
- Use o nome "${t}" na mensagem
- Tom de voz: ${this.personalization.toneOfVoice}
- NÃ­vel de emojis: ${this.personalization.emojiLevel}
- MÃ¡ximo ${this.personalization.maxMessageLength} caracteres
- ${this.personalization.greetingByTime?"Inclua saudaÃ§Ã£o baseada no horÃ¡rio":"Sem saudaÃ§Ã£o temporal"}
- ${this.personalization.useFirstName?"Use apenas o primeiro nome":"Use nome completo"}`,s}async processAIResponse(e,a,t){const o={content:e.trim(),type:a};switch(a){case"buttons":return{...o,buttons:await this.generateButtons(t)};case"list":return{...o,listItems:await this.generateListItems(t)};default:return o}}async generateButtons(e){const a=[];return e.lastPurchaseProducts&&e.lastPurchaseProducts.length>0&&a.push({id:"reorder",title:"Comprar Novamente",description:"Repetir Ãºltimo pedido"}),e.ltv&&e.ltv>500&&a.push({id:"vip_offers",title:"Ofertas VIP",description:"Ver ofertas exclusivas"}),a.push({id:"catalog",title:"Ver CatÃ¡logo",description:"Produtos disponÃ­veis"}),a.push({id:"support",title:"Falar com Atendente",description:"Suporte personalizado"}),a.slice(0,3)}async generateListItems(e){const a=[];return e.preferredProducts&&e.preferredProducts.length>0?e.preferredProducts.slice(0,5).forEach((t,o)=>{a.push({id:`product_${o}`,title:t,description:"Produto recomendado para vocÃª"})}):a.push({id:"new_arrivals",title:"Novidades",description:"Ãšltimos lanÃ§amentos"},{id:"bestsellers",title:"Mais Vendidos",description:"Produtos populares"},{id:"promotions",title:"PromoÃ§Ãµes",description:"Ofertas especiais"}),a}getFallbackMessage(e,a){const t=this.getFirstName(a.contactName);return{content:{post_sale_confirmation:`${this.getTimeBasedGreeting()} ${t}! ğŸ‰ Seu pedido foi confirmado com sucesso! Em breve vocÃª receberÃ¡ o cÃ³digo de rastreamento. Obrigado pela confianÃ§a! ğŸ˜Š`,post_sale_satisfaction:`Oi ${t}! Como foi sua experiÃªncia com o produto? Sua opiniÃ£o Ã© muito importante para nÃ³s! â­`,cart_abandoned_recovery:`${t}, vocÃª esqueceu alguns itens no seu carrinho! ğŸ›’ Que tal finalizar sua compra? Seus produtos estÃ£o te esperando! ğŸ˜Š`,vip_reactivation:`${t}, sentimos sua falta! ğŸ’ Como cliente VIP, vocÃª tem acesso Ã s nossas melhores ofertas. Vamos conversar?`,lead_nurturing:`Oi ${t}! Espero que esteja bem! ğŸ˜Š Tenho algumas dicas que podem te interessar. Posso compartilhar?`,birthday_celebration:`ğŸ‰ ParabÃ©ns, ${t}! ğŸ‚ Hoje Ã© seu dia especial e preparamos uma surpresa para vocÃª! ğŸ`}[e]||`Oi ${t}! Como posso ajudar vocÃª hoje? ğŸ˜Š`,type:"text"}}getFirstName(e){return e.split(" ")[0]}getTimeBasedGreeting(){const e=new Date().getHours();return e<12?"Bom dia":e<18?"Boa tarde":"Boa noite"}async callOpenAI(e,a){var n,c,l;const t=this.config,i=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.apiKey}`},body:JSON.stringify({model:t.model,messages:[{role:"system",content:`VocÃª Ã© um especialista em vendas e marketing digital para WhatsApp Business.

REGRAS IMPORTANTES:
1. SEMPRE use o nome do cliente na mensagem (fornecido no prompt)
2. Seja natural, amigÃ¡vel e personalizado
3. Use emojis de forma equilibrada (nÃ£o exagere)
4. Mantenha o tom profissional mas caloroso
5. Inclua call-to-action quando apropriado
6. Respeite o limite de caracteres especificado
7. Para mensagens com botÃµes: termine com uma pergunta ou convite Ã  aÃ§Ã£o
8. Para listas: organize informaÃ§Ãµes de forma clara e atrativa
9. Use linguagem brasileira (pt-BR)
10. Evite ser repetitivo ou robÃ³tico

TIPOS DE MENSAGEM:
- text: Mensagem simples de texto
- buttons: Mensagem que terÃ¡ botÃµes interativos (termine com pergunta)
- list: Mensagem que terÃ¡ lista de opÃ§Ãµes (organize o conteÃºdo)

Gere apenas o conteÃºdo da mensagem, sem explicaÃ§Ãµes adicionais.`},{role:"user",content:e}],temperature:t.temperature,max_tokens:t.maxTokens})});if(!i.ok){const p=await i.json();throw new Error(`OpenAI API Error: ${((n=p.error)==null?void 0:n.message)||"Erro desconhecido"}`)}return((l=(c=(await i.json()).choices[0])==null?void 0:c.message)==null?void 0:l.content)||"Erro ao gerar resposta"}async callGemini(e,a){var n,c,l,p,d,u;const t=this.config,o=`VocÃª Ã© um especialista em vendas e marketing digital para WhatsApp Business.

REGRAS IMPORTANTES:
1. SEMPRE use o nome do cliente na mensagem (fornecido no prompt)
2. Seja natural, amigÃ¡vel e personalizado
3. Use emojis de forma equilibrada (nÃ£o exagere)
4. Mantenha o tom profissional mas caloroso
5. Inclua call-to-action quando apropriado
6. Respeite o limite de caracteres especificado
7. Para mensagens com botÃµes: termine com uma pergunta ou convite Ã  aÃ§Ã£o
8. Para listas: organize informaÃ§Ãµes de forma clara e atrativa
9. Use linguagem brasileira (pt-BR)
10. Evite ser repetitivo ou robÃ³tico

TIPOS DE MENSAGEM:
- text: Mensagem simples de texto
- buttons: Mensagem que terÃ¡ botÃµes interativos (termine com pergunta)
- list: Mensagem que terÃ¡ lista de opÃ§Ãµes (organize o conteÃºdo)

Gere apenas o conteÃºdo da mensagem, sem explicaÃ§Ãµes adicionais.

${e}`,i=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${t.model}:generateContent?key=${t.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:o}]}],generationConfig:{temperature:t.temperature,maxOutputTokens:t.maxTokens}})});if(!i.ok){const g=await i.json();throw new Error(`Gemini API Error: ${((n=g.error)==null?void 0:n.message)||"Erro desconhecido"}`)}return((u=(d=(p=(l=(c=(await i.json()).candidates)==null?void 0:c[0])==null?void 0:l.content)==null?void 0:p.parts)==null?void 0:d[0])==null?void 0:u.text)||"Erro ao gerar resposta"}async testConnection(){try{const e=await this.generateText('Teste de conexÃ£o. Responda apenas "OK" se estiver funcionando.');return{success:!0,message:"ConexÃ£o testada com sucesso!"}}catch(e){return{success:!1,message:e instanceof Error?e.message:"Erro desconhecido"}}}}const y=new v;export{y as A};
