var h=Object.defineProperty;var f=(l,e,a)=>e in l?h(l,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):l[e]=a;var p=(l,e,a)=>f(l,typeof e!="symbol"?e+"":e,a);import{L as s}from"./LogService-D1NsVqvs.js";import{M as g}from"./MetricsService-D-XrjjcY.js";class y{constructor(){p(this,"apiUrl");p(this,"campaigns",[]);if(console.log("ðŸ”§ CampaignService: Inicializando..."),console.log("ðŸ”§ CampaignService: window disponÃ­vel:",typeof window<"u"),console.log("ðŸ”§ CampaignService: chatVendasAPI disponÃ­vel:",typeof window<"u"&&!!window.chatVendasAPI),typeof window<"u"&&window.chatVendasAPI){const e=window.chatVendasAPI.getLocalConfig();this.apiUrl=e.apiUrl,console.log("ðŸ”§ CampaignService: Usando API URL do Electron:",this.apiUrl),console.log("ðŸ”§ CampaignService: Config completo:",e)}else this.apiUrl="http://localhost:3002/api",console.log("ðŸ”§ CampaignService: Usando API URL fallback:",this.apiUrl);this.loadInitialData()}async apiCall(e,a={}){try{const t=`${this.apiUrl}${e}`;console.log("ðŸŒ CampaignService.apiCall:",t,a.method||"GET");const n=await fetch(t,{headers:{"Content-Type":"application/json",...a.headers},...a});if(console.log("ðŸ“¡ CampaignService.apiCall response:",n.status,n.statusText),!n.ok){const i=await n.json().catch(()=>({}));throw new Error(i.error||`Erro ${n.status}`)}const r=await n.json();return console.log("âœ… CampaignService.apiCall success:",e,r),r}catch(t){throw console.error("âŒ CampaignService.apiCall error:",e,t),s.error("Campaign API Error","CampaignService",{endpoint:e,error:t}),t}}loadInitialData(){const e=localStorage.getItem("chatvendas_campaigns");e&&(this.campaigns=JSON.parse(e))}save(e=!0){localStorage.setItem("chatvendas_campaigns",JSON.stringify(this.campaigns)),e&&window.dispatchEvent(new Event("campaign-update"))}async getAll(){try{console.log("ðŸ” CampaignService.getAll: Iniciando busca de campanhas..."),console.log("ðŸ” CampaignService.getAll: URL da API:",this.apiUrl);const e=await this.apiCall("/campaigns");return console.log("ðŸ” CampaignService.getAll: Resposta recebida:",e),this.campaigns=(e.data||[]).map(a=>this.mapBackendToFrontend(a)),console.log("ðŸ” CampaignService.getAll: Campanhas mapeadas:",this.campaigns.length),this.save(!1),this.campaigns}catch(e){return console.error("âŒ CampaignService.getAll: Erro detalhado:",e),s.warn("Failed to fetch campaigns from API, using local data","CampaignService"),console.log("ðŸ” CampaignService.getAll: Usando dados locais:",this.campaigns.length),this.campaigns}}async getById(e){try{const a=await this.apiCall(`/campaigns/${e}`);return this.mapBackendToFrontend(a)}catch{return this.campaigns.find(t=>t.id===e)}}mapBackendToFrontend(e){return{id:e.id,name:e.name,status:this.mapBackendStatus(e.status),type:e.message_type||"text",totalLeads:e.total_contacts||0,sentCount:e.messages_sent||0,failedCount:e.messages_failed||0,createdAt:e.created_at,scheduledFor:e.scheduled_at,minDelay:(e.min_delay||e.delay_between_messages||1e4)/1e3,maxDelay:(e.max_delay||e.delay_between_messages||15e3)/1e3,rotateInstances:(e.instances||[]).length>1,messagesPerInstance:e.max_messages_per_instance||50,message:e.message_content,mediaUrl:e.media_url,audienceType:e.target_type||"all",description:e.description,messageType:e.message_type,messageContent:e.message_content,targetType:e.target_type,targetCriteria:e.target_criteria,contactList:e.contact_list||[],instances:e.instances||[],delayBetweenMessages:e.delay_between_messages,delayBetweenInstances:e.delay_between_instances,maxMessagesPerInstance:e.max_messages_per_instance,totalContacts:e.total_contacts,messagesSent:e.messages_sent,messagesFailed:e.messages_failed,startedAt:e.started_at,completedAt:e.completed_at}}mapBackendStatus(e){switch(e){case"draft":return"draft";case"scheduled":return"scheduled";case"running":return"running";case"completed":return"completed";case"failed":return"failed";case"paused":return"paused";default:return"draft"}}async getStats(){try{const e=await this.getAll(),a=e.length,t=e.filter(c=>c.status==="running"||c.status==="scheduled").length,n=e.filter(c=>c.status==="completed").length,r=e.filter(c=>c.status==="failed").length,i=e.reduce((c,o)=>c+(o.sentCount||o.messagesSent||0),0),m=e.reduce((c,o)=>c+(o.totalLeads||o.totalContacts||0),0),d=e.reduce((c,o)=>c+(o.failedCount||o.messagesFailed||0),0),u=i>0?(i-d)/i*100:0;return{total:a,active:t,completed:n,failed:r,totalSent:i,totalLeads:m,successRate:Math.round(u*100)/100}}catch(e){return s.error("Failed to calculate campaign stats","CampaignService",e),{total:0,active:0,completed:0,failed:0,totalSent:0,totalLeads:0,successRate:0}}}async create(e){try{s.info("Creating new campaign","CampaignService",{name:e.name}),g.userAction("create_campaign","CampaignService"),console.log("ðŸ“¤ CampaignService.create - Dados recebidos:",e),console.log("ðŸ“¡ CampaignService.create - URL da API:",`${this.apiUrl}/campaigns`);const a=await this.apiCall("/campaigns",{method:"POST",body:JSON.stringify(e)});console.log("ðŸ“¥ CampaignService.create - Resposta do backend:",a);const t=this.mapBackendToFrontend(a);return this.campaigns.unshift(t),this.save(),console.log("âœ… CampaignService.create - Campanha mapeada:",t),t}catch(a){throw console.error("âŒ CampaignService.create - Erro detalhado:",a),s.error("Failed to create campaign","CampaignService",a),a}}async update(e,a){try{const t=await this.apiCall(`/campaigns/${e}`,{method:"PUT",body:JSON.stringify(a)}),n=this.campaigns.findIndex(r=>r.id===e);return n!==-1&&(this.campaigns[n]=t,this.save(!1)),t}catch(t){return s.error("Failed to update campaign","CampaignService",{id:e,error:t}),null}}async uploadMedia(e){try{const a=new FormData;e.forEach(r=>a.append("files",r));const t=await fetch(`${this.apiUrl}/campaigns/upload`,{method:"POST",body:a});if(!t.ok)throw new Error("Erro ao fazer upload das mÃ­dias");return(await t.json()).files}catch(a){throw s.error("Failed to upload campaign media","CampaignService",a),a}}async delete(e){try{return await this.apiCall(`/campaigns/${e}`,{method:"DELETE"}),this.campaigns=this.campaigns.filter(a=>a.id!==e),this.save(),s.info("Campaign deleted","CampaignService",{id:e}),!0}catch(a){return a.message==="Campanha nÃ£o encontrada"?(this.campaigns=this.campaigns.filter(t=>t.id!==e),this.save(),!0):(s.error("Failed to delete campaign","CampaignService",{id:e,error:a}),!1)}}async startSending(e,a){try{s.info("Starting campaign","CampaignService",{id:e}),g.userAction("start_campaign","CampaignService"),console.log("ðŸŽ¯ CampaignService.startSending - Iniciando campanha:",e),console.log("ðŸ“¡ CampaignService.startSending - URL da API:",`${this.apiUrl}/campaigns/${e}/start`),await this.apiCall(`/campaigns/${e}/start`,{method:"POST"}),console.log("âœ… CampaignService.startSending - Campanha iniciada com sucesso");const t=this.campaigns.find(n=>n.id===e);t&&(t.status="running",this.save()),a&&t&&this.simulateProgress(t,a)}catch(t){throw console.error("âŒ CampaignService.startSending - Erro detalhado:",t),s.error("Failed to start campaign","CampaignService",{id:e,error:t}),t}}async pause(e){try{await this.apiCall(`/campaigns/${e}/pause`,{method:"POST"});const a=this.campaigns.find(t=>t.id===e);return a&&(a.status="paused",this.save()),s.info("Campaign paused","CampaignService",{id:e}),!0}catch(a){return s.error("Failed to pause campaign","CampaignService",{id:e,error:a}),!1}}async resume(e){try{await this.apiCall(`/campaigns/${e}/resume`,{method:"POST"});const a=this.campaigns.find(t=>t.id===e);return a&&(a.status="running",this.save()),s.info("Campaign resumed","CampaignService",{id:e}),!0}catch(a){return s.error("Failed to resume campaign","CampaignService",{id:e,error:a}),!1}}async schedule(e,a){try{return await this.update(e,{status:"scheduled",scheduledFor:a})!==null}catch(t){return s.error("Failed to schedule campaign","CampaignService",{id:e,error:t}),!1}}async duplicate(e){try{const a=await this.getById(e);if(!a)return null;const t={name:`${a.name} (CÃ³pia)`,description:a.description,messageType:a.messageType||a.type,messageContent:a.messageContent||a.message||"",mediaUrl:a.mediaUrl,targetType:a.targetType||a.audienceType,targetCriteria:a.targetCriteria||a.audienceFilters,contactList:a.contactList,instances:a.instances||[],delayBetweenMessages:a.delayBetweenMessages||a.minDelay*1e3,delayBetweenInstances:a.delayBetweenInstances,maxMessagesPerInstance:a.maxMessagesPerInstance||a.messagesPerInstance};return await this.create(t)}catch(a){return s.error("Failed to duplicate campaign","CampaignService",{id:e,error:a}),null}}getByStatus(e){return this.campaigns.filter(a=>a.status===e)}getRecent(e=5){return[...this.campaigns].sort((a,t)=>new Date(t.createdAt).getTime()-new Date(a.createdAt).getTime()).slice(0,e)}simulateProgress(e,a){let t=e.sentCount||0;const n=e.totalLeads||e.totalContacts||0,r=setInterval(async()=>{try{const i=await this.getById(e.id);i&&(t=i.sentCount||i.messagesSent||t,a(t,n,i.currentInstanceId||"InstÃ¢ncia Ativa"),(i.status!=="running"||t>=n)&&clearInterval(r))}catch{clearInterval(r)}},2e3)}async sendQuickMessage(e,a){try{s.info("CampaignService",`Enviando mensagem rÃ¡pida para ${e}`);const t=await fetch(`${this.baseUrl}/messages/send-quick`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phoneNumber:e,messageType:a.type,content:a.content})});if(!t.ok){const r=await t.json().catch(()=>({}));throw new Error(r.message||`HTTP ${t.status}`)}const n=await t.json();s.info("CampaignService",`Mensagem rÃ¡pida enviada com sucesso: ${n.messageId}`),g.increment("quick_messages_sent")}catch(t){throw s.error("CampaignService",`Erro ao enviar mensagem rÃ¡pida: ${t}`),g.increment("quick_messages_failed"),t}}}const C=new y;export{C};
