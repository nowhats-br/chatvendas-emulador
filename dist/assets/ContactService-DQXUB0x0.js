var I=Object.defineProperty;var E=(d,e,o)=>e in d?I(d,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):d[e]=o;var D=(d,e,o)=>E(d,typeof e!="symbol"?e+"":e,o);import{O as A}from"./OrderService-B3PyY6dO.js";import{L as b}from"./LogService-D1NsVqvs.js";const T=["11","12","13","14","15","16","17","18","19","21","22","24","27","28"],_=["31","32","33","34","35","37","38","41","42","43","44","45","46","47","48","49","51","53","54","55","61","62","64","63","65","66","67","68","69","71","73","74","75","77","79","81","87","82","83","84","85","88","86","89","91","93","94","92","97","95","96","98","99"];function C(d){return d.replace(/\D/g,"")}function O(d){if(!d||d.length<8)return!1;const e=d.charAt(0);return["6","7","8","9"].includes(e)}function z(d){const e=d;let o=C(d);if(o.startsWith("55")&&(o=o.substring(2)),o.length<10)return{isValid:!1,originalPhone:e,normalizedPhone:o,ddd:"",number:"",type:"invalid",region:"invalid",error:"NÃºmero muito curto. Deve ter pelo menos DDD + 8 dÃ­gitos."};const n=o.substring(0,2);let t=o.substring(2);const r=T.includes(n),c=_.includes(n);if(!r&&!c)return{isValid:!1,originalPhone:e,normalizedPhone:o,ddd:n,number:t,type:"invalid",region:"invalid",error:`DDD ${n} nÃ£o Ã© vÃ¡lido no Brasil.`};const s=r?"sp_rj":"other",i=O(t);if(i){if(r)if(t.length===8)t="9"+t;else if(t.length===9){if(!t.startsWith("9"))return{isValid:!1,originalPhone:e,normalizedPhone:n+t,ddd:n,number:t,type:"mobile",region:s,error:`Celular do DDD ${n} deve comeÃ§ar com 9.`}}else return{isValid:!1,originalPhone:e,normalizedPhone:n+t,ddd:n,number:t,type:"mobile",region:s,error:`Celular do DDD ${n} deve ter 9 dÃ­gitos.`};else if(t.length===9&&t.startsWith("9"))t=t.substring(1);else if(t.length!==8)return{isValid:!1,originalPhone:e,normalizedPhone:n+t,ddd:n,number:t,type:"mobile",region:s,error:`Celular do DDD ${n} deve ter apenas 8 dÃ­gitos (sem o 9Âº dÃ­gito).`}}const l=i&&r?9:8;if(t.length!==l)return{isValid:!1,originalPhone:e,normalizedPhone:n+t,ddd:n,number:t,type:i?"mobile":"landline",region:s,error:`NÃºmero deve ter ${l} dÃ­gitos para ${i?"celular":"fixo"} do DDD ${n}.`};const h=n+t;return{isValid:!0,originalPhone:e,normalizedPhone:h,ddd:n,number:t,type:i?"mobile":"landline",region:s}}function N(d){const e=d.map(r=>z(r)),o=e.filter(r=>r.isValid),n=e.filter(r=>!r.isValid),t=e.filter(r=>r.isValid&&r.originalPhone!==r.normalizedPhone);return{valid:o,invalid:n,summary:{total:d.length,valid:o.length,invalid:n.length,normalized:t.length}}}function S(d){const e=z(d);return e.isValid?`55${e.normalizedPhone}@s.whatsapp.net`:d}class V{validatePhone(e){return z(e)}processContactList(e,o={}){const{filterLandlines:n=!1,requireWhatsApp:t=!0,removeDuplicates:r=!0}=o;b.info("Processing contact list with advanced validation","PhoneValidationService",{count:e.length,options:o});const c=e.map(a=>a.phone),s=N(c),i={byDDD:{},byType:{},byRegion:{}};s.valid.forEach(a=>{i.byDDD[a.ddd]=(i.byDDD[a.ddd]||0)+1,i.byType[a.type]=(i.byType[a.type]||0)+1,i.byRegion[a.region]=(i.byRegion[a.region]||0)+1});const l=new Map,h=[];s.valid.forEach(a=>{const m=a.normalizedPhone,u=l.get(m)||0;if(l.set(m,u+1),u===1)h.push({phone:a.originalPhone,normalizedPhone:m,occurrences:u+1});else if(u>1){const f=h.find(w=>w.normalizedPhone===m);f&&(f.occurrences=u+1)}});let p=s.valid,g=0;if(r){const a=new Set;p=p.filter(m=>a.has(m.normalizedPhone)?(g++,!1):(a.add(m.normalizedPhone),!0))}if(n){const a=p.length;p=p.filter(m=>(m.type==="mobile",!0)),g+=a-p.length}const v=p.map((a,m)=>{const u=e.find(f=>f.phone===a.originalPhone);return{phone:a.originalPhone,normalizedPhone:a.normalizedPhone,whatsappId:`55${a.normalizedPhone}@s.whatsapp.net`,name:(u==null?void 0:u.name)||`Contato ${m+1}`,wasNormalized:a.originalPhone!==a.normalizedPhone,type:a.type,hasWhatsApp:!0,ddd:a.ddd}}),$=s.invalid.map((a,m)=>({phone:a.originalPhone,error:a.error||"NÃºmero invÃ¡lido",line:m+1,reason:this.categorizeError(a.error||"")})),P={total:e.length,valid:v.length,invalid:$.length,normalized:s.summary.normalized,duplicates:h.length,mobile:i.byType.mobile||0,landline:i.byType.landline||0,whatsappCapable:v.length,filtered:g};return b.info("Contact processing completed with advanced validation","PhoneValidationService",P),{success:P.valid>0,summary:P,validContacts:v,invalidContacts:$,duplicateContacts:h,statistics:i}}categorizeError(e){return e.includes("muito curto")?"too_short":e.includes("muito longo")?"too_long":e.includes("DDD")&&e.includes("nÃ£o Ã© vÃ¡lido")?"invalid_ddd":"invalid_format"}processCSVText(e){const n=e.split(`
`).filter(t=>t.trim()).map((t,r)=>{const c=t.split(",").map(s=>s.trim().replace(/"/g,""));return{phone:c[0]||"",name:c[1]||`Contato ${r+1}`}}).filter(t=>t.phone);return this.processContactList(n)}processPhoneList(e){const n=e.split(`
`).map(t=>t.trim()).filter(t=>t.length>0).map((t,r)=>({phone:t,name:`Contato ${r+1}`}));return this.processContactList(n)}generateImportReport(e){const{summary:o,invalidContacts:n,duplicateContacts:t,validContacts:r,statistics:c}=e;let s=`ðŸ“Š RELATÃ“RIO DETALHADO DE IMPORTAÃ‡ÃƒO

`;if(s+=`ðŸ“ˆ RESUMO GERAL:
`,s+=`â€¢ Total processados: ${o.total}
`,s+=`â€¢ âœ… VÃ¡lidos: ${o.valid} (${(o.valid/o.total*100).toFixed(1)}%)
`,s+=`â€¢ âŒ InvÃ¡lidos: ${o.invalid}
`,s+=`â€¢ ðŸ”§ Normalizados: ${o.normalized}
`,s+=`â€¢ ðŸ”„ Duplicatas: ${o.duplicates}
`,s+=`â€¢ ðŸ“± Celulares: ${o.mobile}
`,s+=`â€¢ ðŸ“ž Fixos: ${o.landline}
`,s+=`â€¢ ðŸ’¬ Com WhatsApp: ${o.whatsappCapable}
`,s+=`â€¢ ðŸš« Filtrados: ${o.filtered}

`,Object.keys(c.byDDD).length>0&&(s+=`ðŸ“ DISTRIBUIÃ‡ÃƒO POR DDD:
`,Object.entries(c.byDDD).sort(([,l],[,h])=>h-l).slice(0,10).forEach(([l,h])=>{const p=(h/o.total*100).toFixed(1);s+=`â€¢ ${l}: ${h} nÃºmeros (${p}%)
`}),Object.keys(c.byDDD).length>10&&(s+=`â€¢ ... e mais ${Object.keys(c.byDDD).length-10} DDDs
`),s+=`
`),o.normalized>0){s+=`ðŸ”§ EXEMPLOS DE NORMALIZAÃ‡ÃƒO:
`;const i=r.filter(l=>l.wasNormalized);i.slice(0,8).forEach(l=>{s+=`â€¢ ${l.phone} â†’ ${l.normalizedPhone} (${l.ddd})
`}),i.length>8&&(s+=`â€¢ ... e mais ${i.length-8} nÃºmeros normalizados
`),s+=`
`}if(n.length>0){s+=`âŒ NÃšMEROS REJEITADOS:
`;const i=n.reduce((l,h)=>(l[h.reason]=(l[h.reason]||0)+1,l),{});Object.entries(i).forEach(([l,h])=>{const p=this.getReasonText(l);s+=`â€¢ ${p}: ${h} nÃºmeros
`}),s+=`
Exemplos de nÃºmeros rejeitados:
`,n.slice(0,5).forEach(l=>{s+=`â€¢ ${l.phone}: ${l.error}
`}),n.length>5&&(s+=`â€¢ ... e mais ${n.length-5} nÃºmeros rejeitados
`),s+=`
`}return t.length>0&&(s+=`ðŸ”„ DUPLICATAS REMOVIDAS:
`,t.slice(0,5).forEach(i=>{s+=`â€¢ ${i.normalizedPhone} (${i.occurrences} ocorrÃªncias)
`}),t.length>5&&(s+=`â€¢ ... e mais ${t.length-5} duplicatas
`),s+=`
`),s+=`âœ… RESULTADO FINAL:
`,s+=`â€¢ ${o.valid} contatos vÃ¡lidos prontos para campanhas
`,s+=`â€¢ ${o.whatsappCapable} nÃºmeros com WhatsApp confirmado
`,s+=`â€¢ Taxa de aproveitamento: ${(o.valid/o.total*100).toFixed(1)}%
`,s}getReasonText(e){return{invalid_format:"Formato invÃ¡lido",invalid_ddd:"DDD invÃ¡lido",too_short:"Muito curto",too_long:"Muito longo",landline_filtered:"NÃºmeros fixos filtrados"}[e]||"Outros erros"}getTestNumbers(){return["1187654321","(11) 8765-4321","11 8765-4321","11987654321","(11) 98765-4321","31987654321","(31) 98765-4321","3187654321","(31) 8765-4321","1133334444","3133334444","123456","00987654321","1198765432123"]}}const y=new V;class x{constructor(){D(this,"contacts",[]);D(this,"API_BASE","http://localhost:3002/api");this.loadInitialData()}async loadInitialData(){try{await this.loadFromBackend()}catch(e){console.warn("Failed to load from backend, using localStorage:",e);const o=localStorage.getItem("chatvendas_contacts");if(o)try{const n=JSON.parse(o);this.contacts=n.map(t=>(t.tags&&Array.isArray(t.tags)?t.tags=t.tags.map(r=>typeof r=="string"?r:r&&typeof r=="object"&&(r.name||r.label||r.text)||String(r)):t.tags=[],t))}catch(n){console.error("Error parsing localStorage contacts, clearing:",n),localStorage.removeItem("chatvendas_contacts"),this.contacts=[]}else this.contacts=[]}}async loadFromBackend(){try{console.log("ðŸ”„ Loading contacts from backend...");const e=await fetch(`${this.API_BASE}/contacts`);if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const o=await e.json(),n=o.data||o;console.log(`ðŸ“¥ Received ${n.length} contacts from backend`),this.contacts=n.map(this.convertBackendContact),this.save(),console.log(`âœ… Successfully loaded ${this.contacts.length} contacts from backend`)}catch(e){throw console.error("âŒ Error loading contacts from backend:",e),e}}convertBackendContact(e){let o=[];if(e.tags)try{let n;typeof e.tags=="string"?n=JSON.parse(e.tags):n=e.tags,Array.isArray(n)&&(o=n.map(t=>typeof t=="string"?t:t&&typeof t=="object"&&(t.name||t.label||t.text)||String(t)))}catch(n){console.warn("Error parsing tags:",n,e.tags),o=[String(e.tags)]}return{id:e.id,name:e.name,phoneNumber:e.phone,normalizedPhone:e.phone,whatsappId:e.whatsapp_id,avatar:e.profile_picture||"",email:e.email||"",tags:o,ltv:e.total_spent||0,walletBalance:0,notes:e.notes||"",lastPurchaseDate:e.last_seen,status:"active",kanbanStage:e.stage||"lead",source:"backend"}}save(){localStorage.setItem("chatvendas_contacts",JSON.stringify(this.contacts)),window.dispatchEvent(new Event("contacts-update"))}async getAll(){try{await this.loadFromBackend()}catch(e){console.warn("Using cached contacts due to backend error:",e)}return[...this.contacts]}getById(e){return this.contacts.find(o=>o.id===e)}async update(e,o){try{const n={name:o.name,phone:o.phoneNumber,email:o.email,stage:o.kanbanStage,tags:o.tags,notes:o.notes,profile_picture:o.avatar},t=await fetch(`${this.API_BASE}/contacts/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!t.ok)throw new Error(`HTTP ${t.status}`);const r=this.contacts.findIndex(c=>c.id===e);r!==-1&&(this.contacts[r]={...this.contacts[r],...o},this.save())}catch(n){console.error("Error updating contact:",n);const t=this.contacts.findIndex(r=>r.id===e);t!==-1&&(this.contacts[t]={...this.contacts[t],...o},this.save())}}updateStage(e,o){this.update(e,{kanbanStage:o})}getPurchaseHistory(e){return A.getAll().slice(0,Math.floor(Math.random()*5))}validatePhone(e){return y.validatePhone(e)}async createContactWithValidation(e){const o=this.validatePhone(e.phoneNumber);if(!o.isValid)return{success:!1,error:o.error||"NÃºmero de telefone invÃ¡lido"};try{const n={name:e.name,phone:o.normalizedPhone,email:e.email,stage:e.kanbanStage,tags:e.tags,notes:e.notes},t=await fetch(`${this.API_BASE}/contacts`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!t.ok){const s=await t.json();throw new Error(s.error||`HTTP ${t.status}`)}const r=await t.json(),c=this.convertBackendContact(r);return this.contacts.unshift(c),this.save(),{success:!0,contact:c}}catch(n){console.error("Error creating contact in backend:",n);const t={...e,id:`contact_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,normalizedPhone:o.normalizedPhone,whatsappId:S(o.normalizedPhone)};return this.contacts.unshift(t),this.save(),{success:!0,contact:t}}}importContactsFromPhoneList(e){const o=y.processPhoneList(e);return o.success&&(o.validContacts.forEach(n=>{const t={id:`contact_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:n.name||"Contato Importado",phoneNumber:n.phone,normalizedPhone:n.normalizedPhone,whatsappId:n.whatsappId,avatar:"",email:"",tags:["Importado"],ltv:0,walletBalance:0,notes:n.wasNormalized?`NÃºmero normalizado de ${n.phone}`:"",status:"lead",kanbanStage:"lead"};this.contacts.unshift(t)}),this.save()),o}importContactsFromCSV(e){const o=y.processCSVText(e);return o.success&&(o.validContacts.forEach(n=>{const t={id:`contact_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:n.name||"Contato Importado",phoneNumber:n.phone,normalizedPhone:n.normalizedPhone,whatsappId:n.whatsappId,avatar:"",email:"",tags:["Importado"],ltv:0,walletBalance:0,notes:n.wasNormalized?`NÃºmero normalizado de ${n.phone}`:"",status:"lead",kanbanStage:"lead"};this.contacts.unshift(t)}),this.save()),o}normalizeAllContacts(){let e=0;const o=[];return this.contacts.forEach(n=>{if(!n.normalizedPhone){const t=this.validatePhone(n.phoneNumber);t.isValid?(n.normalizedPhone=t.normalizedPhone,n.whatsappId=S(t.normalizedPhone),t.originalPhone!==t.normalizedPhone&&(e++,n.notes=(n.notes||"")+` [NÃºmero normalizado de ${t.originalPhone}]`)):o.push({id:n.id,name:n.name,error:t.error||"NÃºmero invÃ¡lido"})}}),e>0&&this.save(),{normalized:e,errors:o}}getValidContactsForCampaign(){return this.contacts.filter(e=>e.normalizedPhone&&e.whatsappId&&e.status==="active")}}const F=new x;export{F as C};
