var c=Object.defineProperty;var h=(n,e,t)=>e in n?c(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var p=(n,e,t)=>h(n,typeof e!="symbol"?e+"":e,t);import{L as l}from"./LogService-D1NsVqvs.js";import{M as m}from"./MetricsService-D-XrjjcY.js";class u{constructor(){p(this,"apiUrl");p(this,"templates",[]);if(typeof window<"u"&&window.chatVendasAPI){const e=window.chatVendasAPI.getLocalConfig();this.apiUrl=e.apiUrl}else this.apiUrl="http://localhost:3002/api";this.loadInitialData()}async apiCall(e,t={}){try{const a=await fetch(`${this.apiUrl}${e}`,{headers:{"Content-Type":"application/json",...t.headers},...t});if(!a.ok){const s=await a.json().catch(()=>({}));throw new Error(s.error||`Erro ${a.status}`)}return await a.json()}catch(a){throw l.error("Template API Error","TemplateService",{endpoint:e,error:a}),a}}loadInitialData(){const e=localStorage.getItem("chatvendas_templates");e?this.templates=JSON.parse(e):(this.templates=[],this.save())}save(){localStorage.setItem("chatvendas_templates",JSON.stringify(this.templates)),window.dispatchEvent(new Event("template-update"))}async getAll(){try{const e=await this.apiCall("/templates");return this.templates=e.data||[],this.save(),this.templates}catch{return l.warn("Failed to fetch templates from API, using local data","TemplateService"),this.templates}}async getById(e){try{return await this.apiCall(`/templates/${e}`)}catch{return this.templates.find(a=>a.id===e)}}async getByCategory(e){try{return(await this.apiCall(`/templates?category=${e}`)).data||[]}catch{return this.templates.filter(a=>a.category===e)}}async getByType(e){try{return(await this.apiCall(`/templates?type=${e}`)).data||[]}catch{return this.templates.filter(a=>a.type===e)}}async create(e){try{l.info("Creating new template","TemplateService",{name:e.name}),m.userAction("create_template","TemplateService");const t=await this.apiCall("/templates",{method:"POST",body:JSON.stringify(e)});return this.templates.push(t),this.save(),t}catch(t){l.error("Failed to create template","TemplateService",t);const a={...e,id:`tpl_${Date.now()}`,usageCount:0,isActive:!0,createdAt:new Date().toISOString()};return this.templates.push(a),this.save(),a}}async update(e,t){try{const a=await this.apiCall(`/templates/${e}`,{method:"PUT",body:JSON.stringify(t)}),s=this.templates.findIndex(o=>o.id===e);return s!==-1&&(this.templates[s]=a,this.save()),a}catch(a){l.error("Failed to update template","TemplateService",{id:e,error:a});const s=this.templates.findIndex(o=>o.id===e);return s!==-1?(this.templates[s]={...this.templates[s],...t},this.save(),this.templates[s]):null}}async delete(e){try{return await this.apiCall(`/templates/${e}`,{method:"DELETE"}),this.templates=this.templates.filter(t=>t.id!==e),this.save(),l.info("Template deleted","TemplateService",{id:e}),!0}catch(t){l.error("Failed to delete template","TemplateService",{id:e,error:t});const a=this.templates.length;return this.templates=this.templates.filter(s=>s.id!==e),this.templates.length!==a?(this.save(),!0):!1}}async duplicate(e){try{const t=await this.getById(e);if(!t)return null;const a={name:`${t.name} (CÃ³pia)`,description:t.description,type:t.type,category:t.category,content:t.content,variables:t.variables};return await this.create(a)}catch(t){return l.error("Failed to duplicate template","TemplateService",{id:e,error:t}),null}}async incrementUsage(e){try{await this.apiCall(`/templates/${e}/usage`,{method:"POST"});const t=this.templates.find(a=>a.id===e);t&&(t.usageCount=(t.usageCount||0)+1,this.save())}catch(t){l.warn("Failed to increment template usage","TemplateService",{id:e,error:t})}}async search(e){try{return(await this.apiCall(`/templates?search=${encodeURIComponent(e)}`)).data||[]}catch{const a=e.toLowerCase();return this.templates.filter(s=>s.name.toLowerCase().includes(a)||s.description&&s.description.toLowerCase().includes(a)||s.type.toLowerCase().includes(a)||s.category&&s.category.toLowerCase().includes(a))}}getStats(){const e=this.templates.length,t=this.templates.reduce((r,i)=>(r[i.type]=(r[i.type]||0)+1,r),{}),a=this.templates.reduce((r,i)=>(i.category&&(r[i.category]=(r[i.category]||0)+1),r),{}),s=this.templates.reduce((r,i)=>r+(i.usageCount||0),0),o=[...this.templates].sort((r,i)=>(i.usageCount||0)-(r.usageCount||0)).slice(0,5);return{total:e,byType:t,byCategory:a,totalUsage:s,mostUsed:o}}}const w=new u;export{w as T};
