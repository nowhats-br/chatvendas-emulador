var r=Object.defineProperty;var o=(n,e,s)=>e in n?r(n,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[e]=s;var i=(n,e,s)=>o(n,typeof e!="symbol"?e+"":e,s);class d{constructor(){i(this,"apiUrl");i(this,"wsUrl");i(this,"ws",null);i(this,"eventListeners",new Map);if(typeof window<"u"&&window.chatVendasAPI){const e=window.chatVendasAPI.getLocalConfig();this.apiUrl=e.apiUrl,this.wsUrl=e.wsUrl}else this.apiUrl="http://localhost:3002/api",this.wsUrl="ws://localhost:3002";this.initWebSocket()}initWebSocket(){try{this.ws=new WebSocket(this.wsUrl),this.ws.onopen=()=>{var e;console.log("ðŸ“¡ WhatsAppService: WebSocket conectado"),(e=this.ws)==null||e.send(JSON.stringify({type:"subscribe",data:{events:["qr_code","instance_connected","instance_status_changed","new_message","new_ticket","ticket_created","ticket_updated","ticket_status_updated","ticket_deleted","message_sent","message_status_updated","message_updated","message_deleted","contact_created","contact_updated","contact_stage_changed"]}}))},this.ws.onmessage=e=>{try{const s=JSON.parse(e.data);this.handleWebSocketMessage(s)}catch(s){console.error("âŒ WhatsAppService: Erro ao processar mensagem WebSocket:",s)}},this.ws.onclose=()=>{console.warn("ðŸ”Œ WhatsAppService: WebSocket desconectado"),this.ws=null,setTimeout(()=>this.initWebSocket(),5e3)},this.ws.onerror=e=>{var s,t,a;console.error("âŒ WhatsAppService: Erro WebSocket:",e),((s=this.ws)==null?void 0:s.readyState)!==WebSocket.CLOSED&&((t=this.ws)==null?void 0:t.readyState)!==WebSocket.CLOSING&&((a=this.ws)==null||a.close())}}catch(e){console.error("âŒ WhatsAppService: Erro ao inicializar WebSocket:",e),setTimeout(()=>this.initWebSocket(),5e3)}}handleWebSocketMessage(e){const{type:s,data:t}=e,a=(t==null?void 0:t.provider)||"baileys";switch(s!=="client_id"&&console.log(`ðŸ“¡ [${a.toUpperCase()}] Evento: ${s}`,t),s){case"client_id":break;case"instance_connected":case"instanceConnected":this.emit("instanceConnected",t);break;case"instance_status_changed":case"instance_status":case"instanceStatusChanged":this.emit("instanceStatusChanged",t);break;case"qr_code":case"qrCode":this.emit("qrCode",t);break;case"new_message":this.emit("newMessage",t);break;case"contact_created":this.emit("contactCreated",t);break;case"contact_updated":this.emit("contactUpdated",t);break;case"contact_stage_changed":this.emit("contactStageChanged",t);break;case"new_ticket":case"ticket_created":this.emit("newTicket",t);break;case"ticket_updated":this.emit("ticketUpdated",t);break;case"ticket_status_updated":this.emit("ticketStatusUpdated",t);break;case"ticket_deleted":this.emit("ticketDeleted",t);break;case"message_sent":this.emit("messageSent",t);break;case"message_status_updated":this.emit("messageStatusUpdated",t);break;case"message_updated":this.emit("messageUpdated",t);break;case"message_deleted":this.emit("messageDeleted",t);break;default:console.log("ðŸ“¨ WhatsAppService: Mensagem nÃ£o tratada:",s)}}emit(e,s){(this.eventListeners.get(e)||[]).forEach(a=>{try{a(s)}catch(c){console.error(`âŒ Erro listener ${e}:`,c)}}),window.dispatchEvent(new CustomEvent(`whaileys-${e}`,{detail:s}))}on(e,s){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(s)}off(e,s){const t=this.eventListeners.get(e);if(t){const a=t.indexOf(s);a>-1&&t.splice(a,1)}}async apiCall(e,s={}){try{const t=await fetch(`${this.apiUrl}${e}`,{headers:{"Content-Type":"application/json",...s.headers},...s});if(!t.ok){const a=await t.json().catch(()=>({})),c=new Error(a.error||`Erro ${t.status}`);throw c.status=t.status,c}return await t.json()}catch(t){throw console.error(`âŒ API Error ${e}:`,t),t}}async getAll(){try{return(await this.apiCall("/instances")).data||[]}catch{return[]}}async createInstance(e,s,t="baileys"){const a=await this.apiCall("/instances",{method:"POST",body:JSON.stringify({name:e,phoneNumber:s,provider:t})});return this.emit("instanceCreated",a),a}async deleteInstance(e){await this.apiCall(`/instances/${e}`,{method:"DELETE"}),this.emit("instanceDeleted",{id:e})}async connect(e){await this.apiCall(`/instances/${e}/connect`,{method:"POST"}),this.emit("instanceConnecting",{id:e})}async disconnect(e){await this.apiCall(`/instances/${e}/disconnect`,{method:"POST"}),this.emit("instanceDisconnecting",{id:e})}async getQrCode(e){try{const s=await this.apiCall(`/instances/${e}/qr`);return{base64:s.qrCode,expiresIn:Math.floor((new Date(s.expiresAt).getTime()-Date.now())/1e3)}}catch(s){if(s instanceof Error&&s.message.includes("QR Code nÃ£o disponÃ­vel")){console.log("ðŸ”„ QR Code nÃ£o disponÃ­vel, forÃ§ando geraÃ§Ã£o..."),await this.generateQrCode(e),await new Promise(a=>setTimeout(a,3e3));const t=await this.apiCall(`/instances/${e}/qr`);return{base64:t.qrCode,expiresIn:Math.floor((new Date(t.expiresAt).getTime()-Date.now())/1e3)}}throw s}}async generateQrCode(e){await this.apiCall(`/instances/${e}/generate-qr`,{method:"POST"})}async getInstanceStatus(e){return await this.apiCall(`/instances/${e}/status`)}async updateInstance(e,s){const t=await this.apiCall(`/instances/${e}`,{method:"PUT",body:JSON.stringify(s)});return this.emit("instanceUpdated",t),t}async sendMessage(e,s,t){return await this.apiCall("/messages/send",{method:"POST",body:JSON.stringify({instanceId:e,contactId:s,...t})})}async getMessages(e,s=1,t=50){return await this.apiCall(`/messages/tickets/${e}?page=${s}&limit=${t}`)}isConnected(){var e;return((e=this.ws)==null?void 0:e.readyState)===WebSocket.OPEN}destroy(){this.ws&&(this.ws.close(),this.ws=null),this.eventListeners.clear()}}const l=new d;export{l as W};
